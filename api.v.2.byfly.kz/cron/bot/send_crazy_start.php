<?php
include('/var/www/www-root/data/www/api.v.2.byfly.kz/config.php');

// ะคัะฝะบัะธั ะดะปั ะณะตะฝะตัะฐัะธะธ ัะปััะฐะนะฝัั ะฒะฐัะธะฐัะธะน ัะพะพะฑัะตะฝะธะน
function generateMessageVariations()
{
    $greetings = ["ะัะธะฒะตัััะฒัั", "ะะดัะฐะฒััะฒัะนัะต", "ะะพะฑััะน ะดะตะฝั", "ะัะธะฒะตั"];
    $versions = ["ะฝะพะฒะฐั ะฒะตััะธั ะะฒั 3.0", "ะพะฑะฝะพะฒะปัะฝะฝะฐั ะะฒะฐ 3.0", "ัะพะฒะตััะตะฝะฝะพ ะฝะพะฒะฐั ะะฒะฐ"];
    $features = [
        "ะฃะถะต ะดะพัััะฟะฝั: ัะผะฝัะน ะฟะพะดะฑะพั ัััะพะฒ, ะผะณะฝะพะฒะตะฝะฝัะต ะพัะฒะตัั ะธ ัะบัะบะปัะทะธะฒะฝัะต ะฟัะตะดะปะพะถะตะฝะธั!",
        "ะขะตะฟะตัั ั: ัะปัััะตะฝะฝัะผ ะธะฝัะตััะตะนัะพะผ, ะฟะตััะพะฝะฐะปัะฝัะผะธ ัะตะบะพะผะตะฝะดะฐัะธัะผะธ ะธ ะฑัััััะผะธ ะพัะฒะตัะฐะผะธ!",
        "ะะพะฒัะต ะฒะพะทะผะพะถะฝะพััะธ: ะธะฝัะตะปะปะตะบััะฐะปัะฝัะน ะฟะพะธัะบ, ะธะฝะดะธะฒะธะดัะฐะปัะฝัะต ะฟัะตะดะปะพะถะตะฝะธั ะธ ะผะพะผะตะฝัะฐะปัะฝะฐั ะฟะพะดะดะตัะถะบะฐ!"
    ];

    $mainMessage = "โจ *" . $greetings[array_rand($greetings)] . "!* โจ\n\nะฏ - " . $versions[array_rand($versions)] . "! ๐ค๐\n\nะะพั ะพะฑะฝะพะฒะปะตะฝะธะต ัะบะพัะพ ะฒัะนะดะตั ะฒ *Google Play* ะธ *AppStore*! ๐ฒ\n\n" . $features[array_rand($features)] . "\n\nะะพัะพะฒะฐ ัะฐััะบะฐะทะฐัั ะพะฑะพ ะฒัะตั ะฝะพะฒัะตััะฒะฐั ะธ ะฝะพะฒะพัััั ะบะพะผะฟะฐะฝะธะธ! ๐\n\n#ByFlyTravel #ะะฒะฐ30 #ะะพะฒะพะตะะพะบะพะปะตะฝะธะต";

    return $mainMessage;
}

// ะคัะฝะบัะธั ะดะปั ะพัะฟัะฐะฒะบะธ ัะพะพะฑัะตะฝะธะน ั ะทะฐะดะตัะถะบะพะน
function sendDelayedMessages($groups)
{
    global $db; // ะะพะฑะฐะฒะปัะตะผ ะดะพัััะฟ ะบ ะณะปะพะฑะฐะปัะฝะพะน ะฟะตัะตะผะตะฝะฝะพะน $db

    $countGroups = count($groups);
    $processed = 0;

    foreach ($groups as $group) {
        $chatId = $group['chatid'];
        $groupName = $group['theme'];
        $processed++;

        echo "ะะฑัะฐะฑะฐััะฒะฐะตะผ ะณััะฟะฟั $processed/$countGroups: $groupName (ID: $chatId)\n";

        // ะัะฟัะฐะฒะปัะตะผ ะพะฑัะฐัะฝัะน ะพัััะตั ั ะธะฝัะตัะฒะฐะปะพะผ 5 ัะตะบัะฝะด
        sendWhatsappGroup($chatId, "๐ *3...*");
        sleep(5);

        sendWhatsappGroup($chatId, "๐ *3... 2...*");
        sleep(5);

        sendWhatsappGroup($chatId, "๐ *3... 2... 1...*");
        sleep(5);

        // ะัะฟัะฐะฒะปัะตะผ ะพัะฝะพะฒะฝะพะต ัะพะพะฑัะตะฝะธะต ั ัะฝะธะบะฐะปัะฝะพะน ะฒะฐัะธะฐัะธะตะน
        $mainMessage = generateMessageVariations();
        sendWhatsappGroup($chatId, $mainMessage);

        // ะกะปััะฐะนะฝะฐั ะทะฐะดะตัะถะบะฐ ะผะตะถะดั 5 ะธ 10 ัะตะบัะฝะดะฐะผะธ ะฟะตัะตะด ัะปะตะดัััะตะน ะณััะฟะฟะพะน
        $delay = rand(5, 10);
        if ($processed < $countGroups) {
            echo "ะะฐัะทะฐ ะฟะตัะตะด ัะปะตะดัััะตะน ะณััะฟะฟะพะน: $delay ัะตะบัะฝะด\n";
            sleep($delay);
        }
    }
}

// ะะพะปััะฐะตะผ ัะฟะธัะพะบ ะฒัะตั ะณััะฟะฟ ะธะท ะฑะฐะทั ะดะฐะฝะฝัั
$query = "SELECT chatid, theme FROM group_dont_byfly WHERE checked = 1 
          UNION 
          SELECT group_id as chatid, title_group as theme FROM user_whatsapp_groups";
$result = $db->query($query);

if (!$result) {
    die("ะัะธะฑะบะฐ ะฒัะฟะพะปะฝะตะฝะธั ะทะฐะฟัะพัะฐ: " . $db->error);
}

$groups = [];
while ($row = $result->fetch_assoc()) {
    $groups[] = $row;
}

// ะะตัะตะผะตัะธะฒะฐะตะผ ะณััะฟะฟั ะดะปั ัะปััะฐะนะฝะพะณะพ ะฟะพััะดะบะฐ
shuffle($groups);

// ะะฐะฟััะบะฐะตะผ ะพัะฟัะฐะฒะบั
sendDelayedMessages($groups);

echo "ะะฐัััะปะบะฐ ะทะฐะฒะตััะตะฝะฐ! ะัะตะณะพ ะพะฑัะฐะฑะพัะฐะฝะพ ะณััะฟะฟ: " . count($groups) . "\n";

// ะะพะณะธััะตะผ ะดะตะนััะฒะธะต
adminNotification("ะัะฟะพะปะฝะตะฝะฐ ะฑะตะทะพะฟะฐัะฝะฐั ัะฐัััะปะบะฐ ัะพะพะฑัะตะฝะธะน ะะฒั 3.0 ะฒ " . count($groups) . " ะณััะฟะฟ WhatsApp");
?>