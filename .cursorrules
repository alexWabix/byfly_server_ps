# ByFly Server Project - AI Instructions

## Общая информация о проекте

Это серверная часть туристической платформы ByFly - комплексное решение для туристических агентств Казахстана.

## Структура проекта

### 1. api.v.2.byfly.kz/ (Основной API сервер)
- **Технологии**: PHP 7.4+, MySQL/MariaDB
- **Конфигурация**: `config.php` - настройки БД и API
- **Точка входа**: `index.php` - главный роутер API

#### Ключевые директории:
- `methods/` - API эндпоинты (более 3500 PHP файлов)
- `cron/` и `cron2.0/` - Планировщик задач (cron jobs)
- `kaspi/` - Интеграция с Kaspi платежами (класс: kaspi_class.php)
- `whatsapp_bot/` - WhatsApp бот (PHP версия)
- `js_bot_wa/` - WhatsApp бот (Node.js версия)
- `eva/` - AI-ассистент Eva (генерация аудио/видео)
- `genrate_print/` - Генерация печатных документов (использует Composer)
- `generate_video/` - Генерация видео контента
- `mekka_tours/` - Специализированные туры в Мекку
- `shop/` - Магазин (PDF каталоги)

#### Важные файлы:
- `config.php` - конфигурация БД (использовать mysqli)
- `smsc_api.php` - SMS интеграция
- `kaspi_class.php` - класс для работы с Kaspi платежами
- `eva.php` - AI ассистент
- `text-to-audio.php` - генерация аудио

### 2. byfly.kz/ (Главный веб-сайт)
- **Технологии**: PHP, LESS, JavaScript
- **Структура**:
  - `api/` - локальные API эндпоинты
  - `app/` - Flutter веб-приложение
  - `blocks/` - UI компоненты (LESS/JS)
  - `dist/` - скомпилированные файлы
  - `vendor/` - PHP зависимости (Composer)

### 3. byfly-travel.com/ (Туристический портал)
- Мероприятия и акции
- Генерация ваучеров (`vaucher.php`)
- Розыгрыши (`rozegrysh/`)
- Акции (`sales/`)

### 4. manager.byfly.kz/ (Панель управления)
- **Функции**: управление заказами, агентами, документами
- **Структура**:
  - `modules/` - PHP модули
  - `pages/` - страницы панели
  - `2.0/` - новая версия (если существует)

## Правила работы с кодом

### PHP
1. **Стиль кода**: Используется процедурный стиль PHP с некоторыми классами
2. **База данных**: Подключение через mysqli (см. config.php)
3. **Кодировка**: UTF-8 везде
4. **Безопасность**: 
   - Всегда экранировать SQL запросы (mysqli_real_escape_string)
   - Проверять права доступа пользователей
   - Валидировать входные данные

### Работа с API методами
- Все методы в `api.v.2.byfly.kz/methods/`
- Структура запросов: POST/GET к index.php с параметром method
- Ответы в формате JSON
- Авторизация через токены/сессии

### Интеграции

#### Kaspi
- Класс: `kaspi_class.php`
- Методы в `kaspi/`
- Cron задачи: `cron2.0/kaspi_*.php`

#### WhatsApp Bot
- PHP версия: `whatsapp_bot/`
- Node.js версия: `js_bot_wa/` (требует npm install)

#### Eva AI
- Аудио: `eva/audio_generator.php`
- Видео: `eva/video_agent/`
- Переводы: `eva_translate.php`

#### SMS
- Используется SMSC API (`smsc_api.php`)

### Composer пакеты
- Используется в `byfly.kz/` и `api.v.2.byfly.kz/genrate_print/`
- Команда установки: `composer install`

### Cron задачи
- Старые: `cron/`
- Новые: `cron2.0/`
- Включают:
  - Проверку платежей Kaspi
  - Рассылки
  - Разблокировку пользователей
  - Переводы пользователей

## Базы данных

### Подключение
```php
// config.php содержит:
// $host, $user, $password, $database
$conn = mysqli_connect($host, $user, $password, $database);
mysqli_set_charset($conn, "utf8mb4");
```

### Основные таблицы (предположительно)
- users - пользователи
- orders - заказы
- tours - туры
- agents - агенты
- payments - платежи
- kaspi_* - таблицы Kaspi интеграции

## Debugging

### Логи ошибок
- PHP error_log
- Kaspi логи: `cron2.0/kaspi_clear_logs.php`

### Тестирование
- `test.php`, `tested.php` - тестовые файлы

## Команды для работы

### PHP
```bash
# Запуск встроенного сервера
php -S localhost:8000

# Проверка синтаксиса
php -l file.php
```

### Composer
```bash
# Установка зависимостей
cd byfly.kz && composer install
cd api.v.2.byfly.kz/genrate_print && composer install
```

### Node.js (WhatsApp Bot)
```bash
cd api.v.2.byfly.kz/js_bot_wa
npm install
node index.js
```

## Важные замечания

1. **Не изменять config.php без согласования** - содержит продакшн настройки
2. **Осторожно с cron задачами** - они влияют на реальные платежи и рассылки
3. **Kaspi интеграция критична** - тестировать в sandbox режиме
4. **Eva AI** - требует API ключи (проверять в соответствующих файлах)
5. **Всегда делать бэкап БД** перед миграциями

## Файлы конфигурации

- `api.v.2.byfly.kz/config.php` - БД и API ключи
- `api.v.2.byfly.kz/version.json` - версия приложения
- `byfly.kz/version.json` - версия сайта
- `composer.json` - PHP зависимости
- `package.json` (в js_bot_wa) - Node.js зависимости

## Git workflow

- Основная ветка: `main`
- Перед коммитом проверять:
  - Нет ли критических файлов (config.php с паролями)
  - Работоспособность измененных методов
  - Совместимость с существующим API

## Дополнительные ресурсы

- README.md - документация проекта
- db_structure.txt - структура БД
- instruktions*.txt - инструкции

---

При работе с этим проектом всегда:
1. Проверяй config.php для понимания структуры БД
2. Изучай существующие методы в methods/ перед созданием новых
3. Следуй существующим паттернам кода
4. Тестируй интеграции (Kaspi, WhatsApp) в безопасном режиме
5. Документируй новые методы и изменения

